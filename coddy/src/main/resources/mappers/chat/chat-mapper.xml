<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "mybatis-3-mapper.dtd" >
<mapper namespace="chatMapper">
	
	<resultMap id="chatRoomResultSet" type="chatRoom">
		<result column="ROOM_ID" property="roomId" />
		<result column="USER_NO" property="userNo" />
		<result column="USER_NAME" property="userName" />
		<result column="USER_PHOTO" property="userPhoto" />
		<result column="MASTER_NO" property="masterNo" />
		<result column="MASTER_NAME" property="masterName" />
		<result column="MASTER_PHOTO" property="masterPhoto" />
	</resultMap>
	
	<resultMap id="chatMessageResultMap" type="chatMessage">
		<result column="CHATR_NO" property="messageId" />
		<result column="PROJECT_NO" property="roomId" />
		<result column="MEMBER_NO" property="memberNo" />
		<result column="MEMBER_NAME" property="memberName" />
		<result column="CHATR_MSG" property="message" />		
	</resultMap>
	
		
	<select id="selectChatRoom" parameterType="string" resultMap="chatRoomResultSet">
		SELECT P.PROJECT_NO AS "ROOM_ID",
			   M1.MEMBER_NO AS "USER_NO",
		       M1.MEMBER_NAME AS "USER_NAME",
		       M1.MEMBER_PHOTO_EXTEND AS "USER_PHOTO",
		       M2.MEMBER_NO AS "MASTER_NO",
		       M2.MEMBER_NAME AS "MASTER_NAME",
		       M2.MEMBER_PHOTO_EXTEND AS "MASTER_PHOTO"
		  FROM CHAT C,MEMBER M1, MEMBER M2, PROJECT P
		 WHERE C.CHAT_MEMBER1 = M1.MEMBER_NO
		   AND C.CHAT_MEMBER2 = M2.MEMBER_NO
		   AND C.PROJECT_NO = P.PROJECT_NO
		   AND C.PROJECT_NO = #{roomId}
	</select>
	
	<insert id="insertMessage" parameterType="chatMessage">		     
		INSERT INTO CHAT_RECORD(CHATR_NO, 
								PROJECT_NO, 
								CHATR_SENDER, 
								CHATR_MSG)
						 VALUES(SEQ_CHAT_RECORD.NEXTVAL, 
						 		#{roomId},
						 		#{memberNo},
						 		#{message})
	</insert>
	
	<select id="messageList" parameterType="_int" resultMap="chatMessageResultMap">
		SELECT C.CHATR_NO, C.PROJECT_NO, M.MEMBER_NO , M.MEMBER_NAME, C.CHATR_MSG
		  FROM CHAT_RECORD C, MEMBER M
		 WHERE C.CHATR_SENDER = M.MEMBER_NO
	  	   AND C.PROJECT_NO = #{roomId}
	     ORDER BY CHATR_INSERT ASC
	</select>
	
</mapper>