<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "mybatis-3-mapper.dtd" >
<mapper namespace="introMapper"> 

	<resultMap id="introResultSet" type="intro">
			<result column="IBOARD_NO" property="iboardNo"/>
			<result column="IBOARD_TITLE" property="iboardTitle"/>
			<result column="IBOARD_CONTENT" property="iboardContent"/>
			<result column="IBOARD_WRITER" property="iboardWriter"/>
			<result column="IBOARD_INSERT" property="iboardInsert"/>
			<result column="IBOARD_UPDATE" property="iboardUpdate"/>
			<result column="IBOARD_DELETE" property="iboardDelete"/>
			<result column="PROJECT_NO" property="projectNo"/>
			<result column="IBOARD_VIEWS" property="iboardViews"/>
	</resultMap>
	
		<resultMap id="introAttachmentResultSet" type="introAttachment">
			<result column="IATTACHMENT_NO" property="iAttachmentNo"/>
			<result column="IBOARD_NO" property="iboardNo"/>
			<result column="IATTACHMENT_ORIGIN" property="iAttachmentOrigin"/>
			<result column="IATTACHMENT_CHANGE" property="iAttachmentChange"/>
			<result column="IATTACHMENT_PATH" property="iAttachmentPath"/>
			<result column="IATTACHMENT_INSERT" property="iAttachmentInsert"/>
			<result column="IATTACHMENT_LEVEL" property="iAttachmentLevel"/>
	</resultMap>

	<resultMap id="pRelationResultSet" type="pRelation">
		<result column="RECRUITMENT_NO" property="recruitmentNo"/>
		<result column="TAGS_NO" property="tagsNo"/>
	</resultMap>
	
	<resultMap id="LikesSet" type="likes">
		<result column="LIKES_MEMBER" property="likesMember"/>
		<result column="IBOARD_NO" property="iboardNo"/>
	</resultMap>
	
	<resultMap id="ireplyResultSet" type="ireply">
		<result column="IREPLY_NO" property="ireplyNo"/>
		<result column="MEMBER_NO" property="memberNo"/>
		<result column="IBOARD_NO" property="iboardNo"/>
		<result column="IREPLY_PARENT" property="ireplyParent"/>
		<result column="IREPLY_CONTENT" property="ireplyContent"/>
		<result column="IREPLY_INSERT" property="ireplyInsert"/>
		<result column="IREPLY_UPDATE" property="ireplyUpdate"/>
		<result column="IREPLY_DELETE" property="ireplyDelete"/>
	</resultMap>
	
	<resultMap id="ireplyImageResultSet" type="ireplyImage">
		<result column="IREPLY_NO" property="ireplyNo"/>
		<result column="MEMBER_NO" property="memberNo"/>
		<result column="MEMBER_NAME" property="memberName"/>
		<result column="IBOARD_NO" property="iboardNo"/>
		<result column="IREPLY_PARENT" property="ireplyParent"/>
		<result column="IREPLY_CONTENT" property="ireplyContent"/>
		<result column="IREPLY_INSERT" property="ireplyInsert"/>
		<result column="IREPLY_UPDATE" property="ireplyUpdate"/>
		<result column="IREPLY_DELETE" property="ireplyDelete"/>
	</resultMap>
	
	<insert id="insertBoard" parameterType="intro">
		INSERT INTO IBOARD(
			IBOARD_NO,
			IBOARD_TITLE,
			IBOARD_CONTENT,
			IBOARD_WRITER,	
			PROJECT_NO
		) VALUES (
				SEQ_IBOARD.NEXTVAL,
				#{iboardTitle},
				#{iboardContent},
				#{iboardWriter},
				2
		)
	</insert>
	
	<insert id="insertBoardImg" parameterType="introAttachment">
		INSERT INTO IATTACHMENT(
			IATTACHMENT_NO,
			IBOARD_NO,
			IATTACHMENT_ORIGIN,
			IATTACHMENT_PATH,
			IATTACHMENT_CHANGE,
			IATTACHMENT_LEVEL
		) VALUES (
			SEQ_IATTACHMENT.NEXTVAL,
			SEQ_IBOARD.CURRVAL,
			#{iAttachmentOrigin},
			#{iAttachmentPath},
			#{iAttachmentChange},
			#{iAttachmentLevel}
		)
		
	</insert>
	
	<select id="selectListCount" parameterType="isearch" resultType="_int">
				SELECT COUNT (DISTINCT(I.IBOARD_NO)) 
				  FROM IBOARD I, PRELATION PR, TAGS TG, RECRUITMENT RE, PROJECT P
				 WHERE PR.RECRUITMENT_NO = RE.RECRUITMENT_NO 
				   AND PR.TAGS_NO = TG.TAGS_NO 
				   AND TG.TAGS_NAME IN 
		<foreach collection="tags" item="item" index="index" open="(" close=")" separator=",">#{item}</foreach>
				   AND I.IBOARD_DELETE IS NULL
				   AND (I.IBOARD_TITLE LIKE '%'||#{keyword}||'%' 
				    OR P.PROJECT_NAME LIKE '%'||#{keyword}||'%') 
				 ORDER BY ${sort} DESC
	</select>
	
	<select id="selectList" parameterType="isearch" resultMap="introResultSet">
		SELECT DISTINCT I.IBOARD_NO AS "IBOARD_NO",
		 	   I.IBOARD_TITLE AS "IBOARD_TITLE", 
		 	   P.PROJECT_NO AS "PROJECT_NO",
		 	   I.IBOARD_VIEWS AS "IBOARD_VIEWS",
		 	   I.IBOARD_CONTENT AS "IBOARD_CONTENT",
		 	   M.MEMBER_NAME AS "IBOARD_WRITER",
		 	   TO_CHAR(I.IBOARD_INSERT, 'YYYY-MM-DD') AS "IBOARD_INSERT",
		 	   P.PROJECT_START AS "PROJECT_START",
		 	   P.PROJECT_END AS "PROJECT_END"
		 	   FROM IBOARD I, PROJECT P, PRELATION PR, TAGS TG, RECRUITMENT RE, MEMBER M
		WHERE PR.RECRUITMENT_NO = RE.RECRUITMENT_NO
		AND I.PROJECT_NO = P.PROJECT_NO
		AND PR.TAGS_NO = TG.TAGS_NO
		AND M.MEMBER_NO = I.IBOARD_WRITER
		AND TG.TAGS_NAME IN
		<foreach collection="tags" item="item" index="index" open="(" close=")" separator=",">#{item}</foreach>
		AND I.IBOARD_DELETE IS NULL 
		AND (I.IBOARD_TITLE LIKE '%'||#{keyword}||'%' 
		OR I.IBOARD_CONTENT LIKE '%'||#{keyword}||'%'
		OR P.PROJECT_NAME LIKE '%'||#{keyword}||'%')
		ORDER BY ${sort} DESC
	</select>
	
	<select id="selectattachment" parameterType="introAttachment" resultMap="introAttachmentResultSet">
     SELECT IATTACHMENT_NO,
            IBOARD_NO, 
            IATTACHMENT_ORIGIN, 
            IATTACHMENT_CHANGE, 
            IATTACHMENT_PATH,
            IATTACHMENT_INSERT, 
            IATTACHMENT_LEVEL 
      FROM IATTACHMENT 
     WHERE IBOARD_NO = #{iboardNo} 
       AND IATTACHMENT_LEVEL = 1
	</select>
	
	<update id="increaseCount" parameterType="_int">
		UPDATE IBOARD
		   SET IBOARD_VIEWS = IBOARD_VIEWS + 1
		 WHERE IBOARD_NO = #{iboardNo}
		   AND IBOARD_DELETE IS NULL
	</update>
	
	<select id="getTagInfo" parameterType="pRelation" resultMap="pRelationResultSet">
	SELECT RE.RECRUITMENT_NO, 
	       T.TAGS_NAME AS "TAGS_NO" 
	FROM RECRUITMENT RE, TAGS T, PRELATION PR 
	WHERE PR.TAGS_NO = T.TAGS_NO 
	AND RE.RECRUITMENT_NO = #{recruitMentNo}
	</select>
	
	<select id="getWishList" parameterType="intro" resultType="_int">
		SELECT COUNT(*) 
		  FROM LIKES 
		 WHERE IBOARD_NO=#{iboardNo} 
		   AND LIKES_MEMBER = #{iboardContent}
    </select>
    
  	<select id="getWish" parameterType="likes" resultType="_int">
	  	SELECT COUNT(*) 
	  	  FROM LIKES 
	     WHERE IBOARD_NO = #{iboardNo} 
	  	   AND LIKES_MEMBER = #{likesMember}
  	</select>
	<delete id="deleteWish" parameterType="likes">
	DELETE 
	  FROM LIKES 
	 WHERE LIKES_MEMBER = #{likesMember} 
	   AND IBOARD_NO = #{iboardNo}
	</delete>
	<insert id="insertWish" parameterType="likes">
	INSERT INTO LIKES(LIKES_MEMBER,
	                  IBOARD_NO) 
	           VALUES(#{likesMember},
	                  #{iboardNo})
    </insert>  
    
    <update id="plusView" parameterType="_int">
    UPDATE IBOARD 
       SET IBOARD_VIEWS = IBOARD_VIEWS + 1 
     WHERE IBOARD_NO = #{ino} 
       AND IBOARD_DELETE IS NULL
   </update>
   
   <select id="selectBoard" parameterType="_int" resultMap="introResultSet">
   SELECT I.IBOARD_NO,
   		  I.IBOARD_TITLE,
   		  I.IBOARD_CONTENT,
   		  I.IBOARD_INSERT,
   		  I.IBOARD_VIEWS,
  		  M.MEMBER_NAME AS "IBOARD_WRITER"
     FROM IBOARD I, MEMBER M 
    WHERE I.IBOARD_WRITER = M.MEMBER_NO
      AND IBOARD_NO = #{ino} 
      AND IBOARD_DELETE IS NULL
   </select>
    
    <select id="getAttachmentList" parameterType="intro" resultMap="introAttachmentResultSet">
    SELECT * 
      FROM IATTACHMENT 
     WHERE IBOARD_NO = #{iboardNo} 
       AND IATTACHMENT_LEVEL = 0
    </select>
    
    <select id="getAllWish" parameterType="_int" resultType="_int">
    	SELECT COUNT(*) 
    	  FROM LIKES 
    	 WHERE IBOARD_NO = #{iboardNo}
    </select>
    
     <update id="deleteForm" parameterType="_int">
  		UPDATE IBOARD
  		SET IBOARD_DELETE = SYSDATE
  		WHERE IBOARD_NO = #{iboardNo}
  	</update>
    
   <select id="selectReplyList" parameterType="_int" resultMap="ireplyImageResultSet">
  	SELECT I.IREPLY_NO AS "IREPLY_NO"
  		, M.MEMBER_NO AS "MEMBER_NO"
  		, M.MEMBER_NAME AS "MEMBER_NAME"
  		, I.IREPLY_CONTENT AS "IREPLY_CONTENT"
  		, TO_CHAR(I.IREPLY_INSERT, 'YYYY-MM-DD') AS "IREPLY_INSERT"
  		FROM IREPLY I, MEMBER M
  		WHERE M.MEMBER_NO = I.MEMBER_NO
  		AND I.IREPLY_DELETE IS NULL
  		AND I.IBOARD_NO = #{iboardNo}
  		ORDER BY I.IREPLY_NO DESC
   </select>
    
   <insert id="insertReply" parameterType="ireply">
  	INSERT INTO IREPLY(IREPLY_NO
  					, IREPLY_CONTENT
  					, IBOARD_NO
  					, MEMBER_NO
  					, IREPLY_INSERT)
  			VALUES(SEQ_IREPLY.NEXTVAL
  					, #{ireplyContent}
  					, #{iboardNo}
  					, #{memberNo}
  					, SYSDATE)
  </insert>
  
     <update id="deletereply" parameterType="_int">
  		UPDATE IREPLY
  		   SET IREPLY_DELETE = SYSDATE
  		 WHERE IREPLY_NO = #{ireplyNo}
  	</update>
  
  	<update id="updatereply" parameterType="ireply">
  		UPDATE IREPLY
  		   SET IREPLY_CONTENT = #{ireplyContent},
  		   	   IREPLY_INSERT = SYSDATE
  		 WHERE IREPLY_NO = #{ireplyNo}
  	</update>
  	
  	<select id="selectTopList" resultMap="introResultSet">
  				SELECT ROWNUM, B.*
		  FROM (SELECT IBOARD_NO
		             , IBOARD_TITLE
		             , IBOARD_WRITER
		             , IBOARD_VIEWS
		             , TO_CHAR(IBOARD_INSERT, 'YYYY-MM-DD') AS "IBOARD_INSERT"
		          FROM IBOARD
		         WHERE IBOARD_DELETE IS NULL
		         ORDER BY COUNT DESC) B
		 WHERE ROWNUM BETWEEN 1 AND 5
  	</select>
  	
</mapper>
	